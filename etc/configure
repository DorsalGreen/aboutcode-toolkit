#!/bin/bash
#
# Copyright (c) 2014 nexB Inc. http://www.nexb.com/ - All rights reserved.
#

ETC_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ABOUT_ROOT_DIR="$( dirname "$ETC_DIR" )"

if [ "$1" == "--clean" ]; then
    echo "* Cleaning ..."
    cd $ABOUT_ROOT_DIR && rm -rf build bin lib include about_code_tool.egg-info AboutCode.egg-info build dist
    exit 0
fi


CONFIGURED_PYTHON=$ABOUT_ROOT_DIR/bin/python

# Install and activate a virtualenv without any download
if [ ! -f "$CONFIGURED_PYTHON" ]; then
    echo ""
    echo "* Configuring Python ..."
    python2.7 $ABOUT_ROOT_DIR/thirdparty/virtualenv.py --never-download --extra-search-dir=$ABOUT_ROOT_DIR/thirdparty/ $ABOUT_ROOT_DIR
fi

source $ABOUT_ROOT_DIR/bin/activate


# Install components from selected requirements
echo ""
echo "* Installing components ..."
for req in $($CONFIGURED_PYTHON $ETC_DIR/getconf.py --requirements $@)
    do pip install --upgrade --no-allow-external --use-wheel --no-index --find-links=$ABOUT_ROOT_DIR/thirdparty/ -r $ABOUT_ROOT_DIR/$req
done

# Run selected configuration python scripts
echo ""
echo "* Configuring ..."
for script in $($CONFIGURED_PYTHON $ETC_DIR/getconf.py --python $@)
    do python $ABOUT_ROOT_DIR/$script
done

# Run selected configuration command line scripts
for script in $($CONFIGURED_PYTHON $ETC_DIR/getconf.py --shell $@)
    do source $ABOUT_ROOT_DIR/$script
done

# Set exec permission on all files in bin
chmod -R ogu+x $ABOUT_ROOT_DIR/bin

# enable local usage of entry points scripts
cd "$ABOUT_ROOT_DIR"
pip install --upgrade --no-allow-external --use-wheel --no-index --find-links=$ABOUT_ROOT_DIR/thirdparty/ --editable .
